‚ÄúYou are now in full autonomous debug + production hardening mode.
Carefully modify ONLY the existing main.py without removing any major architecture. Keep all routes, logs, and integrations. Apply ALL fixes below in ONE pass and return ONLY the final working main.py.

1Ô∏è‚É£ BACKEND CONNECTIVITY (CRITICAL)

Force ALL backend API calls to use:

BASE_API_URL = "https://5ef5530c-38d9-4731-b470-827087d7bc6f-00-2j327r1fnap1d.sisko.replit.dev:8000/api"


Remove any reference to port 5000 for backend.

Add 5-second timeout + exponential retry (max 2 attempts) for all backend requests.

If backend still unreachable ‚Üí speak:

‚ÄúOur booking system is temporarily unavailable, but I will save your request and confirm shortly.‚Äù

2Ô∏è‚É£ JWT AUTH FIX

Remove ALL module-level global JWT_TOKEN.

Implement:

Auto login on startup

Auto refresh token on 401

Never block call flow when login temporarily fails

If login fails, do NOT break AI conversation.

3Ô∏è‚É£ NLU MEMORY LOOP FIX (DROP-OFF ISSUE)

Once these fields are captured, NEVER ask again unless user explicitly changes it:

pickup_location

dropoff_location

datetime

passengers

Add hard lock flags:

pickup_locked
dropoff_locked
time_locked
passengers_locked


Only ask next missing slot.

Prevent the system from resetting slots after backend failure.

4Ô∏è‚É£ CONTACT NUMBER CONFIRMATION (PROPER LOGIC)

Ask exactly like this (ONLY ONCE):

‚ÄúAap jis number se call kar rahe hain, kya main isi number ko contact number ke taur par confirm kar loon, ya aap koi aur number dena chahte hain?‚Äù

Logic:

If user says ‚Äúyes / same / isi ko‚Äù ‚Üí save caller number.

If user says ‚Äúdifferent‚Äù ‚Üí explicitly ask new number.

Never re-ask this again once saved.

5Ô∏è‚É£ CUSTOMER FULL NAME RE-CONFIRMATION (BEFORE BOOKING)

Before booking confirmation, ALWAYS ask ONCE:

‚ÄúBooking confirm karne se pehle main aap ka poora naam dobara verify kar loon?‚Äù

Overwrite any previously stored name with latest answer.

6Ô∏è‚É£ EMAIL CAPTURE (ANTI-LOOP + STRICT VALIDATION)

Ask email ONLY ONCE after name confirmation.

Use regex validation.

If invalid ‚Üí ask again max 2 attempts only.

If still invalid ‚Üí continue booking without email (do NOT loop).

Never ask email again after stored.

7Ô∏è‚É£ FARE CALCULATION GUARANTEE

After pickup + dropoff + vehicle + passengers:

Always call:

POST /api/bookings/calculate-fare


Speak fare in this exact format:

‚ÄúAap ka estimated fare AED {fare} hai.‚Äù

Do NOT skip fare under any condition.

8Ô∏è‚É£ BOOKING CONFIRMATION FLOW (STRICT)

After fare:
Ask:

‚ÄúKya main is fare par aap ki booking confirm kar doon?‚Äù

If:

YES ‚Üí Call:

POST /api/bookings/create-booking


Speak:

‚ÄúAap ki booking successfully confirm ho chuki hai. Shukriya.‚Äù

NO ‚Üí Cancel politely.

9Ô∏è‚É£ URDU MODE FIX (LANGUAGE LOCK)

If user says:

‚ÄúUrdu mein baat karein‚Äù

‚ÄúSpeak in Urdu‚Äù

Lock:

language_mode = "ur"


From that point onward:
‚úÖ All GPT responses
‚úÖ All TTS
‚úÖ All confirmations
MUST be in pure Urdu (not Roman Urdu).

Never revert to English unless user explicitly switches.

üîü TTS + COST OPTIMIZATION

Enable:

MD5 audio caching

Silence trimming

Max TTS length = 240 characters per chunk

Never regenerate same audio twice.

Prevent TTS generation if backend retrying.

Log estimated Twilio + ElevenLabs cost per call.

1Ô∏è‚É£1Ô∏è‚É£ BACKEND HTML ERROR GUARD

If backend returns:

HTML

Empty

502 / 503

Then:

Do NOT reset conversation

Do NOT re-ask pickup/dropoff

Just retry silently once

1Ô∏è‚É£2Ô∏è‚É£ FINAL STATE MACHINE SEQUENCE (ENFORCED)

Conversation order MUST be:

Greeting

Pickup

Drop-off

Date/Time

Passengers

Vehicle preference (optional)

Fare

Name verification

Contact number confirmation

Email

Booking confirmation

API submission

Success message

Never jump backwards unless user explicitly changes something.

‚úÖ FINAL REQUIREMENTS

App must start with:

python main.py


with zero syntax errors.

No repeated questions.

No infinite API retries.

No repeated TTS spending.

No repeated email prompts.

No repeated drop-off loop.

Full flow must complete booking in one call.

‚úÖ After applying all changes:

Restart the workflow

Run one full call test

Ensure booking appears in dashboard

Return ONLY final main.py ‚Äî no explanations, no notes.‚Äù